<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTODROP | CS2 CASES & UPGRADES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #0b0d11;
            --bg-panel: #14171c;
            --accent: #facc15;
            --rarity-blue: #4b69ff;
            --rarity-purple: #8847ff;
            --rarity-pink: #d32ee6;
            --rarity-red: #eb4b4b;
            --rarity-gold: #ebca44;
        }

        body { font-family: 'Rajdhani', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow: hidden; }
        .nav-link.active { color: var(--accent); border-bottom: 3px solid var(--accent); }
        .live-drop-scroll { display: flex; gap: 1rem; animation: scroll-left 40s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #2d3748; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .upgrade-glow { box-shadow: 0 0 40px rgba(168, 85, 247, 0.15); }

        /* Spinner pro bedny */
        .spinner-container {
            position: relative; width: 100%; height: 180px;
            background: linear-gradient(180deg, #101218 0%, #0a0b0e 100%);
            border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        #spinner-track { display: flex; position: absolute; left: 0; height: 100%; align-items: center; will-change: transform; }
        .spinner-item {
            min-width: 140px; height: 140px; margin: 0 4px;
            background: #14171c; border-bottom: 4px solid;
            border-radius: 12px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 10px; position: relative;
            transition: all 0.2s ease;
        }
        .spinner-item img { max-height: 80px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); }
        .spinner-selector {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 4px;
            background: var(--accent); z-index: 10; transform: translateX(-50%);
            box-shadow: 0 0 20px var(--accent);
        }
        .blur-edges { position: absolute; top: 0; bottom: 0; width: 100px; z-index: 5; pointer-events: none; }
        .blur-left { left: 0; background: linear-gradient(90deg, #0b0d11 0%, transparent 100%); }
        .blur-right { right: 0; background: linear-gradient(270deg, #0b0d11 0%, transparent 100%); }
        .fallback-img { filter: grayscale(1) opacity(0.3); }

        /* Vizuální efekty Výhry */
        .win-pop { animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .win-glow-rotate { animation: spin 10s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .particle { position: absolute; border-radius: 50%; pointer-events: none; animation: flyOut 1.5s ease-out forwards; }
        @keyframes flyOut { 
            0% { transform: translate(0, 0) scale(1); opacity: 1; } 
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } 
        }

        /* Upgrade efekty */
        .upgrade-shake { animation: shake 0.5s ease-in-out infinite; border-color: #a855f7 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px) rotate(-1deg); } 75% { transform: translateX(5px) rotate(1deg); } }
    </style>
</head>
<body class="h-screen flex flex-col" onclick="initAudio()">

    <div id="win-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-md transition-all duration-300 opacity-0">
        <div id="win-bg-glow" class="absolute w-[800px] h-[800px] blur-[150px] opacity-40 win-glow-rotate rounded-full"></div>
        
        <div class="text-center relative z-10 w-full max-w-3xl px-8 flex flex-col items-center">
            <h3 class="text-2xl font-black uppercase text-gray-400 tracking-[0.5em] mb-4">Padlo ti</h3>
            <img id="win-image" class="h-80 object-contain drop-shadow-[0_20px_50px_rgba(0,0,0,0.8)] scale-0 mb-8" src="" alt="Skin">
            <h2 id="win-name" class="text-6xl font-black uppercase italic tracking-tighter text-white drop-shadow-xl mb-2"></h2>
            <div id="win-price" class="text-3xl font-bold text-yellow-400 mb-12">0.00 EUR</div>
            
            <div class="flex gap-6 justify-center w-full max-w-lg">
                <button id="btn-win-sell" class="flex-1 bg-green-500 hover:bg-green-600 text-black py-4 rounded-2xl font-black uppercase text-xl transition-all shadow-[0_0_30px_rgba(34,197,94,0.3)] hover:scale-105 active:scale-95">
                    Prodat za <span id="win-sell-price"></span>
                </button>
                <button id="btn-win-keep" class="flex-1 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white py-4 rounded-2xl font-black uppercase text-xl transition-all hover:scale-105 active:scale-95">
                    Nechat v inventáři
                </button>
            </div>
        </div>
        <div id="particles-container" class="absolute inset-0 pointer-events-none overflow-hidden z-20"></div>
    </div>

    <div class="h-16 bg-[#090b0e] border-b border-white/5 flex items-center overflow-hidden z-40">
        <div class="flex-shrink-0 bg-yellow-400 text-black px-6 h-full flex items-center font-black text-xs uppercase italic mr-4 tracking-widest">
            OTODROP LIVE
        </div>
        <div class="flex items-center gap-4 live-drop-scroll" id="live-drops"></div>
    </div>

    <header class="h-20 bg-[#16191f]/90 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-8 z-30">
        <div class="flex items-center gap-10">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="switchPage('cases')">
                <div class="w-12 h-12 bg-yellow-400 rounded-xl flex items-center justify-center text-black font-black text-2xl rotate-2 group-hover:rotate-0 transition-transform shadow-[0_0_20px_rgba(250,204,21,0.3)]">OD</div>
                <div class="flex flex-col leading-tight">
                    <span class="text-3xl font-black italic tracking-tighter">OTO<span class="text-yellow-400">DROP</span></span>
                </div>
            </div>

            <nav class="hidden 2xl:flex items-center gap-6">
                <button onclick="switchPage('cases')" class="nav-link active py-7 px-2 font-bold text-sm uppercase tracking-widest flex items-center gap-2 transition-all hover:text-white">
                    <i data-lucide="box" class="w-4 h-4"></i> Bedny
                </button>
                <button onclick="switchPage('upgrade')" class="nav-link py-7 px-2 font-bold text-sm uppercase tracking-widest flex items-center gap-2 transition-all hover:text-white">
                    <i data-lucide="zap" class="w-4 h-4"></i> Upgrade
                </button>
                <button onclick="switchPage('inventory')" class="nav-link py-7 px-2 font-bold text-sm uppercase tracking-widest flex items-center gap-2 transition-all hover:text-white">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> Inventář
                </button>
            </nav>
        </div>

        <div class="flex items-center gap-6">
            <div class="bg-gray-900/80 px-5 py-2.5 rounded-2xl border border-white/10 flex items-center gap-4 shadow-xl">
                <div class="text-right">
                    <div id="balance" class="font-black text-yellow-400 text-xl leading-none">0.00</div>
                    <div class="text-[9px] text-gray-500 font-bold uppercase tracking-tighter mt-1">Zůstatek (EUR)</div>
                </div>
                <div class="w-10 h-10 bg-yellow-400/10 rounded-xl flex items-center justify-center text-yellow-400">
                    <i data-lucide="coins" class="w-6 h-6"></i>
                </div>
            </div>

            <button onclick="addFreeMoney()" class="bg-green-500/20 hover:bg-green-500 text-green-500 hover:text-white px-4 py-3 rounded-xl font-black transition-all uppercase text-xs border border-green-500/50 shadow-lg active:scale-95">
                + PENÍZE ZDARMA
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto bg-[#0b0d11] relative p-8">
            
            <section id="page-cases" class="page fade-in max-w-7xl mx-auto space-y-10">
                <div class="relative h-[250px] rounded-[32px] overflow-hidden bg-gradient-to-r from-yellow-500/20 to-[#0b0d11] border border-yellow-400/20 shadow-2xl flex items-center px-12 mb-8">
                    <div class="relative z-10 max-w-2xl space-y-4">
                        <div class="inline-block px-4 py-1.5 bg-yellow-400 text-black font-black text-[10px] uppercase tracking-[0.3em] rounded-full italic">ROZŠÍŘENÁ DATABÁZE</div>
                        <h1 class="text-5xl font-black uppercase italic tracking-tighter text-white leading-tight">VÍTEJ NA <span class="text-yellow-400">OTODROP</span></h1>
                        <p class="text-gray-400 text-md font-medium leading-relaxed">Otevři bedny se zvukem asmr tikání nebo použij 3-slotový Upgrader a získej svůj vysněný knife!</p>
                    </div>
                    <i data-lucide="boxes" class="absolute right-10 top-1/2 -translate-y-1/2 w-80 h-80 text-yellow-400/5"></i>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="cases-grid"></div>
            </section>

            <section id="page-case-view" class="page hidden fade-in max-w-6xl mx-auto space-y-8">
                <button onclick="switchPage('cases')" class="text-gray-500 hover:text-white flex items-center gap-2 font-bold uppercase text-xs tracking-widest transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Zpět na bedny
                </button>

                <div class="bg-[#14171c] rounded-3xl border border-white/5 p-8 shadow-2xl text-center">
                    <h2 id="view-case-name" class="text-5xl font-black uppercase italic tracking-tighter text-white drop-shadow-xl">Bedna</h2>
                    <div id="view-case-price" class="text-yellow-400 font-bold text-xl mt-2 mb-8">0.00 EUR</div>

                    <div class="spinner-container relative mb-8">
                        <div class="blur-edges blur-left"></div>
                        <div class="blur-edges blur-right"></div>
                        <div class="spinner-selector"></div>
                        <div id="spinner-track"></div>
                    </div>

                    <button id="btn-open-case" class="bg-yellow-400 hover:bg-yellow-500 text-black px-16 py-5 rounded-2xl font-black uppercase italic transition-all hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(250,204,21,0.3)] text-2xl tracking-tighter">
                        OTEVŘÍT BEDNU
                    </button>
                </div>

                <div>
                    <h3 class="text-xl font-black uppercase italic tracking-tighter text-white mb-4 border-b border-white/10 pb-2">Obsah bedny a šance</h3>
                    <div id="view-case-contents" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
                </div>
            </section>

            <section id="page-upgrade" class="page hidden max-w-6xl mx-auto space-y-10 fade-in">
                <div class="text-center">
                    <h2 class="text-5xl font-black uppercase italic tracking-tighter text-white">OTODROP <span class="text-purple-500">UPGRADER</span></h2>
                    <p class="text-gray-500 font-bold text-xs uppercase tracking-widest mt-1">Slož až 3 skiny dohromady a vyber si cokoliv z databáze</p>
                </div>
                
                <div class="bg-[#14171c] p-10 rounded-3xl border border-white/5 shadow-2xl relative upgrade-glow" id="upgrade-panel">
                    <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-12 items-center">
                        <div class="space-y-4">
                            <h3 class="text-gray-400 font-black uppercase text-sm tracking-widest text-center mb-2">Tvoje skiny (Až 3)</h3>
                            <div class="flex flex-col gap-3" id="upg-inputs-container"></div>
                            <div class="text-center mt-2">
                                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Celková hodnota vkladu:</span>
                                <div id="upg-total-input-val" class="text-purple-400 font-black text-xl">0.00 EUR</div>
                            </div>
                        </div>
                        
                        <div class="text-center space-y-6">
                            <div class="relative">
                                <svg class="w-48 h-48 mx-auto transform -rotate-90">
                                    <circle cx="96" cy="96" r="86" stroke="#1f2937" stroke-width="12" fill="transparent" />
                                    <circle id="upgrade-circle" cx="96" cy="96" r="86" stroke="#a855f7" stroke-width="12" fill="transparent" stroke-dasharray="540" stroke-dashoffset="540" class="transition-all duration-1000 ease-out" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center flex-col">
                                    <span id="upgrade-chance" class="text-5xl font-black text-white italic drop-shadow-lg">0%</span>
                                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Šance</span>
                                </div>
                            </div>
                            <button onclick="attemptUpgrade()" id="btn-upgrade-exec" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-black py-5 rounded-2xl uppercase italic shadow-lg shadow-purple-500/30 active:scale-95 transition-all tracking-tighter text-xl">
                                Vylepšit
                            </button>
                        </div>
                        
                        <div class="space-y-4 h-full flex flex-col justify-center">
                            <h3 class="text-gray-400 font-black uppercase text-sm tracking-widest text-center mb-2">Cílový skin</h3>
                            <div id="upg-target-slot" onclick="openSelector('target')" class="bg-gray-900/50 border-2 border-dashed border-purple-500/50 hover:border-yellow-400 rounded-3xl h-64 flex flex-col items-center justify-center p-4 relative overflow-hidden cursor-pointer transition-all group">
                                <i data-lucide="search" class="w-10 h-10 text-purple-500/50 group-hover:text-yellow-400 mb-2 transition-colors"></i>
                                <span class="text-gray-500 font-bold uppercase text-xs text-center group-hover:text-white transition-colors">Vyber cíl z<br>databáze</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-inventory" class="page hidden max-w-7xl mx-auto space-y-8 fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 border-b border-white/5 pb-6">
                    <div>
                        <h2 class="text-4xl font-black uppercase italic tracking-tighter text-white">MŮJ <span class="text-yellow-400">INVENTÁŘ</span></h2>
                        <p id="inv-stats" class="text-gray-500 font-bold text-xs uppercase tracking-widest mt-1">0 předmětů v hodnotě 0.00 EUR</p>
                    </div>
                    <button onclick="sellAllSkins()" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white px-6 py-3 rounded-xl font-bold text-xs transition-all border border-red-500/20 uppercase tracking-widest">
                        Prodat vše
                    </button>
                </div>
                <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
            </section>

            <section id="page-selector" class="page hidden max-w-7xl mx-auto space-y-8 fade-in">
                <div class="flex items-center justify-between border-b border-white/10 pb-6">
                    <div>
                        <button onclick="switchPage('upgrade')" class="text-gray-500 hover:text-white flex items-center gap-2 font-bold uppercase text-xs tracking-widest transition-colors mb-2">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Zpět do Upgraderu
                        </button>
                        <h2 id="selector-title" class="text-4xl font-black uppercase italic tracking-tighter text-white">VYBER SKIN</h2>
                    </div>
                </div>
                <div id="selector-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
            </section>

        </main>
    </div>

    <div id="toast" class="fixed bottom-10 right-10 bg-yellow-400 text-black px-8 py-4 rounded-2xl font-black shadow-2xl opacity-0 transform translate-y-10 transition-all duration-300 z-[100] uppercase italic tracking-tighter text-lg border-2 border-yellow-300">
        Akce úspěšná!
    </div>

    <script>
        const FALLBACK_IMG = "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjx2jJemkV09-5lpS0lfL3D7fQmGRu58ByiOXO89Wj2Vbtr0BkZmmhcI7HclM4M1vXq1LtxLrugcG8tZ7IznFr6SIn43_D30vgT85F9rU";
        function handleImgError(img) {
            img.onerror = null; 
            img.src = FALLBACK_IMG;
            img.classList.add('fallback-img');
        }
    </script>

    <script>
        // --- AUDIO ENGINE (Web Audio API) ---
        let audioCtx;
        let audioInitialized = false;

        function initAudio() {
            if(!audioInitialized) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioInitialized = true;
            } else if(audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        const SoundEngine = {
            playTick: () => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.03);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.03);
            },
            playWin: (rarity) => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'square';
                
                let baseFreq = rarity === 'gold' ? 523.25 : (rarity === 'red' ? 440 : 329.63); // C5, A4, E4
                osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
                osc.frequency.setValueAtTime(baseFreq * 1.25, audioCtx.currentTime + 0.1);
                osc.frequency.setValueAtTime(baseFreq * 1.5, audioCtx.currentTime + 0.2);
                
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.5);
            },
            playUpgradeProcess: () => {
                if(!audioCtx) return null;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 2); // stoupá 2 sekundy
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                osc.start();
                return { osc, gain };
            },
            playUpgradeFail: () => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            }
        };

        // --- STAV A DATABÁZE ---
        let balanceBase = 0.00;
        const KNIFE_TYPES = ["Bayonet", "Bowie Knife", "Butterfly Knife", "Classic Knife", "Falchion Knife", "Flip Knife", "Gut Knife", "Huntsman Knife", "Karambit", "M9 Bayonet", "Navaja Knife", "Nomad Knife", "Paracord Knife", "Shadow Daggers", "Skeleton Knife", "Stiletto Knife", "Survival Knife", "Talon Knife", "Ursus Knife", "Driver Gloves", "Sport Gloves", "Specialist Gloves", "Hand Wraps", "Moto Gloves"];

        // Přidáno dalších 50 oblíbených skinů
        const rawSkinData = `
P250|Sand Dune|0.10|#4b69ff
Glock-18|Catacombs|0.20|#4b69ff
SSG 08|Abyss|0.50|#4b69ff
P90|Grim|0.80|#4b69ff
M4A4|Magnesium|1.00|#4b69ff
MAC-10|Candy Apple|1.10|#4b69ff
Glock-18|Weasel|1.20|#8847ff
Glock-18|Moonrise|1.50|#8847ff
USP-S|Ticket to Hell|1.80|#8847ff
P250|Asiimov|2.00|#8847ff
AK-47|Elite Build|2.50|#8847ff
M4A1-S|Night Terror|2.50|#8847ff
AWP|Worm God|3.00|#8847ff
USP-S|Cyrex|3.50|#8847ff
AK-47|Slate|4.00|#8847ff
Desert Eagle|Light Rail|4.00|#8847ff
AWP|Mortis|4.50|#d32ee6
Glock-18|Water Elemental|5.00|#d32ee6
USP-S|Cortex|5.00|#d32ee6
Desert Eagle|Conspiracy|6.00|#d32ee6
AK-47|Phantom Disruptor|6.00|#d32ee6
Desert Eagle|Mecha Industries|7.00|#d32ee6
MAC-10|Neon Rider|8.00|#d32ee6
AWP|Atheris|10.00|#8847ff
M4A4|Desolate Space|10.00|#d32ee6
Glock-18|Bullet Queen|12.00|#eb4b4b
FAMAS|Commemoration|12.00|#eb4b4b
M4A1-S|Decimator|14.00|#d32ee6
AK-47|Redline|15.00|#d32ee6
Glock-18|Neo-Noir|15.00|#eb4b4b
M4A4|In Living Color|15.00|#eb4b4b
AK-47|Ice Coaled|18.00|#d32ee6
USP-S|Neo-Noir|18.00|#eb4b4b
M4A4|Neo-Noir|20.00|#d32ee6
AWP|Neo-Noir|25.00|#eb4b4b
USP-S|Orion|25.00|#d32ee6
M4A1-S|Hyper Beast|25.00|#eb4b4b
M4A4|The Emperor|30.00|#eb4b4b
AK-47|Asiimov|35.00|#eb4b4b
M4A1-S|Player Two|35.00|#eb4b4b
AK-47|Neon Rider|40.00|#eb4b4b
USP-S|Kill Confirmed|45.00|#eb4b4b
USP-S|Printstream|55.00|#d32ee6
Desert Eagle|Printstream|60.00|#eb4b4b
AK-47|Bloodsport|75.00|#eb4b4b
AK-47|Vulcan|80.00|#eb4b4b
AWP|Containment Breach|85.00|#eb4b4b
AWP|Asiimov|110.00|#eb4b4b
M4A1-S|Printstream|210.00|#eb4b4b
Desert Eagle|Emerald Jörmungandr|350.00|#eb4b4b
Bayonet|Slaughter|450.00|#ebca44
M4A1-S|Blue Phosphor|700.00|#d32ee6
Glock-18|Fade|800.00|#ebca44
Desert Eagle|Blaze|900.00|#eb4b4b
M9 Bayonet|Doppler|900.00|#ebca44
Talon Knife|Fade|1000.00|#ebca44
Karambit|Tiger Tooth|1000.00|#ebca44
Karambit|Doppler|1100.00|#ebca44
Karambit|Fade|1200.00|#ebca44
M9 Bayonet|Lore|1200.00|#ebca44
Driver Gloves|King Snake|1200.00|#ebca44
Karambit|Marble Fade|1300.00|#ebca44
Butterfly Knife|Slaughter|1400.00|#ebca44
Karambit|Lore|1500.00|#ebca44
M9 Bayonet|Autotronic|1500.00|#ebca44
Butterfly Knife|Doppler|1600.00|#ebca44
Skeleton Knife|Crimson Web|1600.00|#ebca44
Butterfly Knife|Tiger Tooth|1700.00|#ebca44
M9 Bayonet|Crimson Web|1800.00|#ebca44
Skeleton Knife|Fade|1800.00|#ebca44
Butterfly Knife|Marble Fade|2000.00|#ebca44
Sport Gloves|Vice|2000.00|#ebca44
Butterfly Knife|Fade|2200.00|#ebca44
M4A1-S|Welcome to the Jungle|2500.00|#ebca44
AWP|Medusa|3000.00|#ebca44
AK-47|Gold Arabesque|3000.00|#ebca44
M4A4|Howl|3500.00|#ebca44
Sport Gloves|Pandoras Box|4000.00|#ebca44
AK-47|Wild Lotus|4500.00|#ebca44
AWP|Dragon Lore|5000.00|#ebca44
AWP|Gungnir|6000.00|#ebca44`;

        const skinsDB = {};
        
        rawSkinData.trim().split("\n").forEach((line, idx) => {
            const [w, n, p, c] = line.split("|");
            let folder = KNIFE_TYPES.includes(w) ? "knives" : "skins";
            let urlWeapon = w.replace(/ /g, "_");
            let urlName = n.replace(/ /g, "_").replace(/'/g, "");
            skinsDB[idx + 1] = { id: idx + 1, weapon: w, skinName: n, name: `${w} | ${n}`, price: parseFloat(p), color: c, img: `https://www.csgodatabase.com/images/${folder}/webp/${urlWeapon}_${urlName}.webp`, rarityName: c === '#ebca44' ? 'gold' : (c === '#eb4b4b' ? 'red' : (c === '#d32ee6' ? 'pink' : 'blue')) };
        });

        function findSkin(w, n) { return Object.values(skinsDB).find(s => s.weapon === w && s.skinName === n) || Object.values(skinsDB)[0]; }

        const casesDB = [];
        setTimeout(() => {
            casesDB.push(
                {
                    id: "trash-or-knife", name: "1% KNIFE Risk", price: 25.00, color: "yellow-400",
                    img: findSkin("M9 Bayonet", "Autotronic").img,
                    contents: [
                        { skin: findSkin("P250", "Sand Dune"), chance: 99.0 },
                        { skin: findSkin("M9 Bayonet", "Autotronic"), chance: 1.0 }
                    ]
                },
                {
                    id: "coinflip", name: "50/50 Profit", price: 50.00, color: "red",
                    img: findSkin("AK-47", "Bloodsport").img,
                    contents: [
                        { skin: findSkin("AK-47", "Slate"), chance: 50.0 },
                        { skin: findSkin("AK-47", "Bloodsport"), chance: 50.0 }
                    ]
                },
                {
                    id: "budget", name: "Budget Grinder", price: 5.00, color: "blue",
                    img: findSkin("AWP", "Worm God").img,
                    contents: [
                        { skin: findSkin("Glock-18", "Catacombs"), chance: 60.0 },
                        { skin: findSkin("USP-S", "Ticket to Hell"), chance: 25.0 },
                        { skin: findSkin("AWP", "Mortis"), chance: 12.0 },
                        { skin: findSkin("M4A4", "Desolate Space"), chance: 2.5 },
                        { skin: findSkin("AK-47", "Redline"), chance: 0.5 }
                    ]
                },
                {
                    id: "covert", name: "Covert Dreams", price: 100.00, color: "red",
                    img: findSkin("AWP", "Asiimov").img,
                    contents: [
                        { skin: findSkin("M4A4", "The Emperor"), chance: 65.0 },
                        { skin: findSkin("AK-47", "Vulcan"), chance: 25.0 },
                        { skin: findSkin("AWP", "Asiimov"), chance: 8.0 },
                        { skin: findSkin("Desert Eagle", "Emerald Jörmungandr"), chance: 2.0 }
                    ]
                },
                {
                    id: "dragon", name: "Dragon Lore 1%", price: 200.00, color: "yellow-400",
                    img: findSkin("AWP", "Dragon Lore").img,
                    contents: [
                        { skin: findSkin("AWP", "Atheris"), chance: 80.0 },
                        { skin: findSkin("AWP", "Neo-Noir"), chance: 19.0 },
                        { skin: findSkin("AWP", "Dragon Lore"), chance: 1.0 }
                    ]
                }
            );
            renderCases();
        }, 100);

        let userInventory = [];
        let activeCaseId = null;
        let isSpinning = false;
        let spinAnimationId = null;

        // --- ZÁKLADY UI ---
        function formatMoney(val) { return `${val.toLocaleString('cs-CZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} EUR`; }
        function updateUI() { document.getElementById('balance').textContent = formatMoney(balanceBase).replace(' EUR', ''); lucide.createIcons(); }
        function showToast(text, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = text;
            t.style.backgroundColor = isError ? '#ef4444' : '#facc15';
            t.style.color = isError ? 'white' : 'black';
            t.style.borderColor = isError ? '#dc2626' : '#fde047';
            t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        function switchPage(id) {
            if(isSpinning) return;
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const page = document.getElementById(`page-${id}`);
            if (page) page.classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const activeNav = Array.from(document.querySelectorAll('.nav-link')).find(l => l.getAttribute('onclick').includes(`'${id}'`));
            if(activeNav) activeNav.classList.add('active');

            if(id === 'inventory') renderInventory();
            if(id === 'upgrade') renderUpgrader();
            activeCaseId = null; 
        }

        function addFreeMoney() {
            balanceBase += 1000;
            updateUI();
            showToast("Přidáno 1000 EUR!");
            initAudio(); // Pro sichr init z tlačítka
        }

        // --- FULL-SCREEN VÝHERNÍ POPUP A EFEKTY ---
        function createParticles(color) {
            const container = document.getElementById('particles-container');
            container.innerHTML = ''; // Vyčistit staré
            for(let i=0; i<60; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = color;
                const size = Math.random() * 8 + 4;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.left = '50%';
                p.style.top = '50%';
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 400 + 100;
                p.style.setProperty('--tx', `${Math.cos(angle) * velocity}px`);
                p.style.setProperty('--ty', `${Math.sin(angle) * velocity}px`);
                
                container.appendChild(p);
            }
        }

        function showWinModal(skin) {
            const modal = document.getElementById('win-modal');
            const img = document.getElementById('win-image');
            
            document.getElementById('win-name').textContent = skin.name;
            document.getElementById('win-price').textContent = formatMoney(skin.price);
            document.getElementById('win-sell-price').textContent = formatMoney(skin.price);
            document.getElementById('win-bg-glow').style.backgroundColor = skin.color;
            
            img.src = skin.img;
            
            modal.classList.remove('hidden');
            // Malý delay pro CSS tranzici
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                img.classList.add('win-pop');
                
                // Efekty pokud je to red/gold
                if(skin.color === '#eb4b4b' || skin.color === '#ebca44') {
                    createParticles(skin.color);
                }
                
                SoundEngine.playWin(skin.rarityName);
            }, 50);

            // Nastavení tlačítek
            document.getElementById('btn-win-sell').onclick = () => {
                balanceBase += skin.price;
                updateUI();
                showToast(`Získáno ${formatMoney(skin.price)}`);
                closeWinModal();
            };
            
            document.getElementById('btn-win-keep').onclick = () => {
                addToInventory(skin);
                showToast(`Uloženo do inventáře`);
                closeWinModal();
            };
        }

        function closeWinModal() {
            const modal = document.getElementById('win-modal');
            modal.classList.add('opacity-0');
            document.getElementById('win-image').classList.remove('win-pop');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- BEDNY ---
        function renderCases() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = casesDB.map(c => `
                <div onclick="openCaseView('${c.id}')" class="bg-[#14171c] p-6 rounded-3xl border-2 border-transparent hover:border-${c.color}/50 cursor-pointer transition-all group text-center shadow-lg relative overflow-hidden">
                    <div class="absolute inset-0 bg-${c.color}/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <img src="${c.img}" onerror="handleImgError(this)" class="w-full h-32 object-contain group-hover:scale-110 transition-transform relative z-10 drop-shadow-xl mb-4">
                    <div class="font-black text-sm uppercase text-gray-300 relative z-10">${c.name}</div>
                    <div class="text-yellow-400 font-bold mt-1 relative z-10">${formatMoney(c.price)}</div>
                </div>
            `).join('');
        }

        function openCaseView(id) {
            activeCaseId = id;
            const c = casesDB.find(x => x.id === id);
            
            document.getElementById('view-case-name').textContent = c.name;
            document.getElementById('view-case-price').textContent = `${formatMoney(c.price)}`;
            document.getElementById('view-case-name').style.color = getComputedStyle(document.documentElement).getPropertyValue(`--rarity-${c.color === 'yellow-400' ? 'gold' : c.color}`);

            const track = document.getElementById('spinner-track');
            track.style.transition = 'none';
            track.style.transform = 'translateX(0px)';
            track.innerHTML = '';
            
            document.getElementById('view-case-contents').innerHTML = c.contents.map(item => `
                <div class="bg-gray-900/50 p-3 rounded-xl border-b-2 flex flex-col items-center text-center" style="border-color: ${item.skin.color}">
                    <img src="${item.skin.img}" onerror="handleImgError(this)" class="h-16 object-contain mb-2 drop-shadow-md">
                    <div class="text-[9px] font-bold text-gray-400 uppercase truncate w-full">${item.skin.name}</div>
                    <div class="text-[10px] font-black text-white">${item.chance}%</div>
                </div>
            `).join('');

            const btn = document.getElementById('btn-open-case');
            btn.onclick = () => startSpinner(c);
            btn.textContent = "OTEVŘÍT BEDNU";
            btn.disabled = false;
            btn.classList.remove('opacity-50');

            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-case-view').classList.remove('hidden');
        }

        function startSpinner(caseObj) {
            if(isSpinning) return;
            if(balanceBase < caseObj.price) return showToast("Nemáš dostatek peněz!", true);

            balanceBase -= caseObj.price;
            updateUI();
            isSpinning = true;

            const btn = document.getElementById('btn-open-case');
            btn.textContent = "Točí se...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            // Roll
            const roll = Math.random() * 100;
            let sum = 0;
            let winningSkin = caseObj.contents[0].skin;
            for(let item of caseObj.contents) {
                sum += item.chance;
                if(roll <= sum) { winningSkin = item.skin; break; }
            }

            const track = document.getElementById('spinner-track');
            track.style.transition = 'none';
            track.style.transform = 'translateX(0px)';
            
            const totalItems = 60;
            const winningIndex = 50;
            const itemWidth = 148; 

            let html = '';
            for(let i = 0; i < totalItems; i++) {
                let skinToRender = (i === winningIndex) ? winningSkin : caseObj.contents[Math.floor(Math.random() * caseObj.contents.length)].skin;
                html += `
                    <div class="spinner-item" style="border-color: ${skinToRender.color}">
                        <img src="${skinToRender.img}" onerror="handleImgError(this)">
                        <div class="text-[10px] font-black uppercase text-gray-300 mt-2 truncate w-full text-center">${skinToRender.name}</div>
                    </div>
                `;
            }
            track.innerHTML = html;

            setTimeout(() => {
                const containerWidth = document.querySelector('.spinner-container').clientWidth;
                const jitter = (Math.random() * (itemWidth - 20)) - ((itemWidth - 20) / 2); 
                const finalOffset = (winningIndex * itemWidth) + (itemWidth / 2) - (containerWidth / 2) + jitter;

                // Ticking logikca přes requestAnimationFrame
                let lastCrossed = 0;
                function checkTick() {
                    if(!isSpinning) return;
                    const transform = window.getComputedStyle(track).getPropertyValue('transform');
                    if(transform !== 'none') {
                        const matrix = new DOMMatrix(transform);
                        const currentX = Math.abs(matrix.m41);
                        // Vypočte střed obrazovky + to co už ujelo
                        const centerLine = currentX + (containerWidth / 2);
                        const itemIndexAtCenter = Math.floor(centerLine / itemWidth);
                        
                        if(itemIndexAtCenter > lastCrossed) {
                            SoundEngine.playTick();
                            lastCrossed = itemIndexAtCenter;
                            
                            // Visual efekt problesknutí na zasaženém itemu
                            const items = track.children;
                            if(items[itemIndexAtCenter]) {
                                items[itemIndexAtCenter].style.backgroundColor = '#2d3748';
                                setTimeout(() => { if(items[itemIndexAtCenter]) items[itemIndexAtCenter].style.backgroundColor = '#14171c'; }, 100);
                            }
                        }
                    }
                    spinAnimationId = requestAnimationFrame(checkTick);
                }
                
                track.style.transition = 'transform 6s cubic-bezier(0.1, 0, 0.1, 1)';
                track.style.transform = `translateX(-${finalOffset}px)`;
                
                checkTick();

                setTimeout(() => {
                    isSpinning = false;
                    cancelAnimationFrame(spinAnimationId);
                    
                    showWinModal(winningSkin);
                    
                    btn.textContent = "HRÁT ZNOVU";
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }, 6500); 
            }, 50);
        }

        // --- INVENTÁŘ ---
        function addToInventory(skin) {
            userInventory.unshift({ ...skin, uid: Date.now() + Math.random().toString(36).substring(7) });
            updateUI();
        }

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            const stats = document.getElementById('inv-stats');
            if(!grid) return;

            if(userInventory.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-20 font-bold uppercase">Inventář je prázdný.</div>`;
                stats.textContent = `0 předmětů v hodnotě 0.00 EUR`;
                return;
            }

            let totalVal = 0;
            grid.innerHTML = userInventory.map(item => {
                totalVal += item.price;
                return `
                <div class="bg-[#14171c] p-4 rounded-2xl border-b-4 group relative overflow-hidden transition-all hover:scale-105 shadow-lg" style="border-color: ${item.color}">
                    <div class="absolute inset-0 opacity-0 group-hover:opacity-10 transition-opacity" style="background-color: ${item.color}"></div>
                    <img src="${item.img}" onerror="handleImgError(this)" class="w-full h-24 object-contain drop-shadow-xl">
                    <div class="mt-3 text-center">
                        <div class="text-[10px] font-black uppercase text-gray-400 truncate">${item.name}</div>
                        <div class="text-sm font-black text-white mt-1">${formatMoney(item.price)}</div>
                    </div>
                    <button onclick="sellSkin('${item.uid}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 bg-red-500/80 hover:bg-red-500 text-white p-2 rounded-lg transition-all shadow-lg backdrop-blur-sm">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`;
            }).join('');
            
            stats.textContent = `${userInventory.length} předmětů v hodnotě ${formatMoney(totalVal)}`;
            lucide.createIcons();
        }

        function sellSkin(uid) {
            const idx = userInventory.findIndex(i => i.uid === uid);
            if(idx > -1) {
                balanceBase += userInventory[idx].price;
                userInventory.splice(idx, 1);
                updateUI(); renderInventory();
                for(let i=0; i<3; i++) { if(upgInputs[i] && upgInputs[i].uid === uid) upgInputs[i] = null; }
            }
        }

        function sellAllSkins() {
            if(userInventory.length === 0) return;
            balanceBase += userInventory.reduce((acc, curr) => acc + curr.price, 0);
            userInventory = [];
            updateUI(); renderInventory();
            upgInputs = [null, null, null]; upgTarget = null;
        }

        // --- UPGRADER ---
        let upgInputs = [null, null, null];
        let upgTarget = null;

        function renderUpgrader() {
            const container = document.getElementById('upg-inputs-container');
            let totalVal = upgInputs.reduce((acc, curr) => acc + (curr ? curr.price : 0), 0);
            
            container.innerHTML = [0,1,2].map(i => upgInputs[i] ? `
                <div onclick="removeUpgInput(${i})" class="bg-gray-800/80 border border-gray-600 hover:border-red-500 rounded-2xl h-24 flex items-center p-3 cursor-pointer group relative overflow-hidden transition-all">
                    <img src="${upgInputs[i].img}" onerror="handleImgError(this)" class="h-16 w-20 object-contain drop-shadow-md">
                    <div class="ml-3 flex-1 overflow-hidden">
                        <div class="text-[10px] font-bold text-gray-400 uppercase truncate">${upgInputs[i].name}</div>
                        <div class="text-sm font-black text-white">${formatMoney(upgInputs[i].price)}</div>
                    </div>
                    <div class="absolute inset-0 bg-red-500/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity backdrop-blur-[2px]">
                        <i data-lucide="trash-2" class="w-6 h-6 text-red-500"></i>
                    </div>
                </div>
            ` : `
                <div onclick="openSelector('input', ${i})" class="bg-gray-900/50 border-2 border-dashed border-gray-600 hover:border-purple-500 rounded-2xl h-24 flex items-center justify-center cursor-pointer transition-all group">
                    <i data-lucide="plus" class="w-6 h-6 text-gray-600 group-hover:text-purple-500 transition-colors"></i>
                </div>
            `).join('');
            
            document.getElementById('upg-total-input-val').textContent = formatMoney(totalVal);

            if(upgTarget && upgTarget.price <= totalVal) upgTarget = null;

            const targetSlot = document.getElementById('upg-target-slot');
            let chance = 0;

            if(upgTarget) {
                targetSlot.classList.remove('border-dashed', 'border-purple-500/50');
                targetSlot.style.borderColor = upgTarget.color;
                targetSlot.innerHTML = `
                    <div class="absolute inset-0 opacity-20" style="background: linear-gradient(to top, ${upgTarget.color}, transparent);"></div>
                    <img src="${upgTarget.img}" onerror="handleImgError(this)" class="h-32 object-contain drop-shadow-[0_0_20px_rgba(255,255,255,0.2)] mb-2 relative z-10 group-hover:scale-110 transition-transform">
                    <div class="text-xs font-black text-white uppercase text-center relative z-10 w-full truncate px-2" style="color: ${upgTarget.color}">${upgTarget.name}</div>
                    <div class="text-lg font-black text-white relative z-10">${formatMoney(upgTarget.price)}</div>
                `;
                chance = Math.min((totalVal / upgTarget.price) * 100, 90);
            } else {
                targetSlot.removeAttribute('style');
                targetSlot.classList.add('border-dashed', 'border-purple-500/50');
                targetSlot.innerHTML = `<i data-lucide="search" class="w-10 h-10 text-purple-500/50 group-hover:text-yellow-400 mb-2"></i><span class="text-gray-500 font-bold uppercase text-xs text-center group-hover:text-white">Vyber cíl</span>`;
            }

            document.getElementById('upgrade-chance').textContent = chance.toFixed(1) + '%';
            document.getElementById('upgrade-circle').style.strokeDashoffset = 540 - (540 * (chance / 100));
            lucide.createIcons();
        }

        function removeUpgInput(i) { upgInputs[i] = null; renderUpgrader(); }

        function openSelector(type, slotIndex = 0) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-selector').classList.remove('hidden');
            
            const grid = document.getElementById('selector-grid');
            if (type === 'input') {
                document.getElementById('selector-title').textContent = "VYBER SKIN K OBĚTOVÁNÍ";
                let available = userInventory.filter(item => !upgInputs.some(ui => ui && ui.uid === item.uid));
                grid.innerHTML = available.map(item => `
                    <div onclick="upgInputs[${slotIndex}] = userInventory.find(i=>i.uid==='${item.uid}'); switchPage('upgrade');" class="bg-[#1a1e26] p-4 rounded-xl cursor-pointer hover:bg-gray-800 transition-all border-b-4" style="border-color: ${item.color}">
                        <img src="${item.img}" onerror="handleImgError(this)" class="h-20 w-full object-contain mb-3 drop-shadow-md">
                        <div class="text-[10px] text-center truncate font-bold text-gray-400 uppercase">${item.name}</div>
                        <div class="text-sm text-center font-black text-white">${formatMoney(item.price)}</div>
                    </div>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-10 font-bold uppercase">Žádné volné skiny.</div>';
            } else {
                document.getElementById('selector-title').textContent = "VYBER CÍLOVÝ SKIN";
                let totalVal = upgInputs.reduce((acc, curr) => acc + (curr ? curr.price : 0), 0);
                let targets = Object.values(skinsDB).filter(s => s.price > totalVal).sort((a,b) => a.price - b.price);
                grid.innerHTML = targets.map(item => `
                    <div onclick="upgTarget = skinsDB[${item.id}]; switchPage('upgrade');" class="bg-[#1a1e26] p-4 rounded-xl cursor-pointer hover:bg-gray-800 transition-all border-b-4" style="border-color: ${item.color}">
                        <img src="${item.img}" onerror="handleImgError(this)" class="h-20 w-full object-contain mb-3 drop-shadow-md">
                        <div class="text-[10px] text-center truncate font-bold text-gray-400 uppercase">${item.name}</div>
                        <div class="text-sm text-center font-black text-white">${formatMoney(item.price)}</div>
                        <div class="text-[10px] text-center font-bold text-purple-400 mt-1">Šance: ${Math.min((totalVal / item.price)*100, 90).toFixed(1)}%</div>
                    </div>
                `).join('') || '<div class="col-span-full text-center text-gray-500 py-10 font-bold uppercase">Nejprve přidej své skiny.</div>';
            }
        }

        function attemptUpgrade() {
            if(isSpinning) return;
            let totalVal = upgInputs.reduce((acc, curr) => acc + (curr ? curr.price : 0), 0);
            if(totalVal === 0) return showToast("Vlož alespoň jeden skin!", true);
            if(!upgTarget) return showToast("Vyber cílový skin!", true);

            isSpinning = true;
            document.getElementById('btn-upgrade-exec').textContent = "Vylepšuji...";
            document.getElementById('upgrade-panel').classList.add('upgrade-shake');
            
            // Zvuk napětí
            const soundNode = SoundEngine.playUpgradeProcess();

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('upgrade-panel').classList.remove('upgrade-shake');
                document.getElementById('btn-upgrade-exec').textContent = "Vylepšit";
                if(soundNode) { soundNode.gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); }

                let chance = Math.min((totalVal / upgTarget.price) * 100, 90);
                const roll = Math.random() * 100;
                
                upgInputs.forEach(item => { if(item) { userInventory.splice(userInventory.findIndex(i => i.uid === item.uid), 1); } });

                if (roll <= chance) {
                    showWinModal(upgTarget);
                } else {
                    SoundEngine.playUpgradeFail();
                    showToast("Upgrade selhal. Skiny shořely.", true);
                }

                upgInputs = [null, null, null];
                upgTarget = null;
                renderUpgrader();
            }, 2000);
        }

        window.onload = () => { lucide.createIcons(); switchPage('cases'); };
    </script>
</body>
</html>