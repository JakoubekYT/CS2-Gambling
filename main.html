<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTODROP | CS2 CASES & UPGRADES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #0b0d11;
            --bg-panel: #14171c;
            --accent: #facc15;
            --rarity-blue: #4b69ff;
            --rarity-purple: #8847ff;
            --rarity-pink: #d32ee6;
            --rarity-red: #eb4b4b;
            --rarity-gold: #ebca44;
        }

        body { font-family: 'Rajdhani', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow: hidden; }
        .nav-link.active { color: var(--accent); border-bottom: 3px solid var(--accent); }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #2d3748; border-radius: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .upgrade-glow { box-shadow: 0 0 40px rgba(168, 85, 247, 0.15); }

        /* Spinner a Multi-open */
        .spinner-container {
            position: relative; width: 100%; height: 180px;
            background: linear-gradient(180deg, #101218 0%, #0a0b0e 100%);
            border-radius: 16px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }
        #spinner-track { display: flex; position: absolute; left: 0; height: 100%; align-items: center; will-change: transform; }
        .spinner-item {
            min-width: 140px; height: 140px; margin: 0 4px;
            background: #14171c; border-bottom: 4px solid;
            border-radius: 12px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 10px; position: relative;
            transition: all 0.2s ease;
        }
        .spinner-item img { max-height: 80px; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); }
        .spinner-selector {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 4px;
            background: var(--accent); z-index: 10; transform: translateX(-50%);
            box-shadow: 0 0 20px var(--accent);
        }
        .blur-edges { position: absolute; top: 0; bottom: 0; width: 100px; z-index: 5; pointer-events: none; }
        .blur-left { left: 0; background: linear-gradient(90deg, #0b0d11 0%, transparent 100%); }
        .blur-right { right: 0; background: linear-gradient(270deg, #0b0d11 0%, transparent 100%); }
        .fallback-img { filter: grayscale(1) opacity(0.3); }

        /* Multi-open Flip Animace */
        .flip-card { perspective: 1000px; width: 140px; height: 160px; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; }
        .flip-card-front { background: #1a1e26; border: 2px dashed #2d3748; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #4a5568; }
        .flip-card-back { background: #14171c; transform: rotateY(180deg); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; border-bottom: 4px solid; }

        /* Vizuální efekty Výhry */
        .win-pop { animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .win-glow-rotate { animation: spin 10s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .particle { position: absolute; border-radius: 50%; pointer-events: none; animation: flyOut 1.5s ease-out forwards; }
        @keyframes flyOut { 
            0% { transform: translate(0, 0) scale(1); opacity: 1; } 
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } 
        }

        /* Qty tlačítka */
        .qty-btn { background: #1a1e26; border: 1px solid #2d3748; color: #a0aec0; padding: 8px 16px; border-radius: 8px; font-weight: bold; transition: all 0.2s; }
        .qty-btn.active { background: var(--accent); color: black; border-color: var(--accent); box-shadow: 0 0 10px rgba(250,204,21,0.3); }

        /* Live Drops (Plynulý posuv) */
        #live-drops-container { display: flex; flex-wrap: nowrap; overflow: hidden; width: 100%; position: relative; }
        .live-drop-item { flex: 0 0 auto; margin-right: 1rem; transition: transform 0.5s ease-out, opacity 0.5s; opacity: 0; transform: translateX(-20px); }
        .live-drop-item.show { opacity: 1; transform: translateX(0); }
    </style>
</head>
<body class="h-screen flex flex-col" onclick="initAudio()">

    <div id="win-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-md transition-all duration-300 opacity-0 overflow-y-auto py-10">
        <div id="win-bg-glow" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] blur-[150px] opacity-30 win-glow-rotate rounded-full pointer-events-none"></div>
        
        <div class="text-center relative z-10 w-full max-w-5xl px-8 flex flex-col items-center">
            <h3 class="text-2xl font-black uppercase text-gray-400 tracking-[0.5em] mb-8">Získal jsi</h3>
            
            <div id="win-items-grid" class="flex flex-wrap justify-center gap-6 mb-8 w-full">
                </div>

            <div id="win-total-price" class="text-4xl font-bold text-yellow-400 mb-12 drop-shadow-lg">0.00 EUR</div>
            
            <div class="flex flex-col sm:flex-row gap-6 justify-center w-full max-w-2xl">
                <button id="btn-win-sell" class="flex-1 bg-green-500 hover:bg-green-600 text-black py-5 rounded-2xl font-black uppercase text-xl transition-all shadow-[0_0_30px_rgba(34,197,94,0.3)] hover:scale-105 active:scale-95">
                    Prodat za <span id="win-sell-price"></span>
                </button>
                <button id="btn-win-keep" class="flex-1 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white py-5 rounded-2xl font-black uppercase text-xl transition-all hover:scale-105 active:scale-95">
                    Uložit do inventáře
                </button>
            </div>
        </div>
        <div id="particles-container" class="fixed inset-0 pointer-events-none overflow-hidden z-20"></div>
    </div>

    <div id="deposit-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-all duration-300 opacity-0">
        <div class="bg-[#14171c] border border-white/10 rounded-3xl p-8 max-w-md w-full shadow-2xl relative scale-95 transition-transform duration-300" id="deposit-box">
            <button onclick="closeDeposit()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-3xl font-black uppercase italic text-white mb-2">Vklad <span class="text-yellow-400">Předmětů / Peněz</span></h2>
            <p class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-6">Vyber si platební metodu (Připraveno na Backend)</p>
            
            <div class="space-y-4">
                <button onclick="simDeposit(50)" class="w-full bg-white text-black hover:bg-gray-200 flex items-center justify-center gap-3 py-4 rounded-2xl font-black transition-all text-lg">
                    <svg class="w-6 h-6" viewBox="0 0 384 384" fill="currentColor"><path d="M318 128... (zkráceno pro Apple logo)"></path><i data-lucide="apple" class="w-6 h-6"></i> Apple Pay</button>
                <button onclick="simDeposit(50)" class="w-full bg-[#00457C] hover:bg-[#003665] text-white flex items-center justify-center gap-3 py-4 rounded-2xl font-black transition-all text-lg">
                    <i data-lucide="credit-card" class="w-6 h-6"></i> PayPal / Karta
                </button>
                <button onclick="simDeposit(50)" class="w-full bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center gap-3 py-4 rounded-2xl font-black border border-gray-600 transition-all text-lg">
                    <i data-lucide="box" class="w-6 h-6"></i> Vložit CS2 Skiny
                </button>
            </div>
            <div class="mt-6 text-center border-t border-white/5 pt-4">
                <p class="text-[10px] text-gray-600 uppercase">Tyto metody budou napojeny na platební bránu (Stripe/Zen) a Steam boty v produkční verzi.</p>
            </div>
        </div>
    </div>

    <div class="h-16 bg-[#090b0e] border-b border-white/5 flex items-center overflow-hidden z-40">
        <div class="flex-shrink-0 bg-yellow-400 text-black px-6 h-full flex items-center font-black text-xs uppercase italic mr-4 tracking-widest z-10 relative">
            <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse mr-2"></span> LIVE DROPY
        </div>
        <div id="live-drops-container" class="flex items-center">
            </div>
    </div>

    <header class="h-20 bg-[#16191f]/90 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-8 z-30">
        <div class="flex items-center gap-10">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="switchPage('cases')">
                <div class="w-12 h-12 bg-yellow-400 rounded-xl flex items-center justify-center text-black font-black text-2xl rotate-2 group-hover:rotate-0 transition-transform shadow-[0_0_20px_rgba(250,204,21,0.3)]">OD</div>
                <div class="flex flex-col leading-tight">
                    <span class="text-3xl font-black italic tracking-tighter">OTO<span class="text-yellow-400">DROP</span></span>
                </div>
            </div>

            <nav class="hidden 2xl:flex items-center gap-6">
                <button onclick="switchPage('cases')" class="nav-link active py-7 px-2 font-bold text-sm uppercase tracking-widest flex items-center gap-2 transition-all hover:text-white">
                    <i data-lucide="box" class="w-4 h-4"></i> Bedny
                </button>
                <button onclick="switchPage('upgrade')" class="nav-link py-7 px-2 font-bold text-sm uppercase tracking-widest flex items-center gap-2 transition-all hover:text-white">
                    <i data-lucide="zap" class="w-4 h-4"></i> Upgrade
                </button>
                <button onclick="switchPage('inventory')" class="nav-link py-7 px-2 font-bold text-sm uppercase tracking-widest flex items-center gap-2 transition-all hover:text-white">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> Inventář
                </button>
            </nav>
        </div>

        <div class="flex items-center gap-6">
            <div class="bg-gray-900/80 px-5 py-2.5 rounded-2xl border border-white/10 flex items-center gap-4 shadow-xl">
                <div class="text-right">
                    <div id="balance" class="font-black text-yellow-400 text-xl leading-none">0.00</div>
                    <div class="text-[9px] text-gray-500 font-bold uppercase tracking-tighter mt-1">Zůstatek (EUR)</div>
                </div>
                <div class="w-10 h-10 bg-yellow-400/10 rounded-xl flex items-center justify-center text-yellow-400">
                    <i data-lucide="coins" class="w-6 h-6"></i>
                </div>
            </div>

            <button onclick="openDeposit()" class="bg-green-500/20 hover:bg-green-500 text-green-500 hover:text-white px-6 py-3 rounded-xl font-black transition-all uppercase text-xs border border-green-500/50 shadow-lg active:scale-95 flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4"></i> Vklad
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <main class="flex-1 overflow-y-auto bg-[#0b0d11] relative p-8">
            
            <section id="page-cases" class="page fade-in max-w-7xl mx-auto space-y-10">
                <div class="relative h-[250px] rounded-[32px] overflow-hidden bg-gradient-to-r from-yellow-500/20 to-[#0b0d11] border border-yellow-400/20 shadow-2xl flex items-center px-12 mb-8">
                    <div class="relative z-10 max-w-2xl space-y-4">
                        <h1 class="text-5xl font-black uppercase italic tracking-tighter text-white leading-tight">Nejférnější <span class="text-yellow-400">CS2 OPENING</span></h1>
                        <p class="text-gray-400 text-md font-medium leading-relaxed">Otevři bedny nebo použij náš Upgrader s reálnou šancí. Připraveno pro ostrý provoz s reálnými penězi a skiny.</p>
                    </div>
                    <i data-lucide="boxes" class="absolute right-10 top-1/2 -translate-y-1/2 w-80 h-80 text-yellow-400/5"></i>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="cases-grid"></div>
            </section>

            <section id="page-case-view" class="page hidden fade-in max-w-6xl mx-auto space-y-8">
                <div class="flex justify-between items-center">
                    <button onclick="switchPage('cases')" class="text-gray-500 hover:text-white flex items-center gap-2 font-bold uppercase text-xs tracking-widest transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Zpět na bedny
                    </button>
                    <div class="flex items-center gap-4 bg-gray-900 p-2 rounded-xl border border-white/5">
                        <span class="text-xs font-bold text-gray-500 uppercase px-2">Počet:</span>
                        <div class="flex gap-1" id="qty-selector">
                            <button class="qty-btn active" onclick="setOpenQty(1)">1</button>
                            <button class="qty-btn" onclick="setOpenQty(2)">2</button>
                            <button class="qty-btn" onclick="setOpenQty(5)">5</button>
                            <button class="qty-btn" onclick="setOpenQty(10)">10</button>
                        </div>
                        <div class="w-px h-6 bg-gray-700 mx-2"></div>
                        <label class="flex items-center gap-2 cursor-pointer text-xs font-bold text-white uppercase group">
                            <div class="relative">
                                <input type="checkbox" id="fast-open-toggle" class="sr-only">
                                <div class="w-10 h-5 bg-gray-700 rounded-full shadow-inner transition-colors"></div>
                                <div class="dot absolute w-3 h-3 bg-white rounded-full top-1 left-1 transition-transform"></div>
                            </div>
                            <span class="group-hover:text-yellow-400 transition-colors">Bleskové otevření</span>
                        </label>
                    </div>
                </div>

                <div class="bg-[#14171c] rounded-3xl border border-white/5 p-8 shadow-2xl text-center">
                    <h2 id="view-case-name" class="text-5xl font-black uppercase italic tracking-tighter text-white drop-shadow-xl">Bedna</h2>
                    <div id="view-case-price" class="text-yellow-400 font-bold text-xl mt-2 mb-8">0.00 EUR</div>

                    <div id="opening-area" class="min-h-[180px] mb-8 relative flex items-center justify-center">
                        </div>

                    <button id="btn-open-case" class="bg-yellow-400 hover:bg-yellow-500 text-black px-16 py-5 rounded-2xl font-black uppercase italic transition-all hover:scale-105 active:scale-95 shadow-[0_0_30px_rgba(250,204,21,0.3)] text-2xl tracking-tighter">
                        OTEVŘÍT BEDNU
                    </button>
                </div>

                <div>
                    <h3 class="text-xl font-black uppercase italic tracking-tighter text-white mb-4 border-b border-white/10 pb-2">Obsah bedny a šance</h3>
                    <div id="view-case-contents" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
                </div>
            </section>

            <section id="page-upgrade" class="page hidden max-w-6xl mx-auto space-y-10 fade-in">
                <div class="text-center">
                    <h2 class="text-5xl font-black uppercase italic tracking-tighter text-white">OTODROP <span class="text-purple-500">UPGRADER</span></h2>
                    <p class="text-gray-500 font-bold text-xs uppercase tracking-widest mt-1">Slož až 3 skiny dohromady a vyber si cokoliv z databáze</p>
                </div>
                <div class="bg-[#14171c] p-10 rounded-3xl border border-white/5 shadow-2xl relative upgrade-glow" id="upgrade-panel">
                    <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-12 items-center">
                        <div class="space-y-4">
                            <h3 class="text-gray-400 font-black uppercase text-sm tracking-widest text-center mb-2">Tvoje skiny (Až 3)</h3>
                            <div class="flex flex-col gap-3" id="upg-inputs-container"></div>
                            <div class="text-center mt-2">
                                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Celková hodnota vkladu:</span>
                                <div id="upg-total-input-val" class="text-purple-400 font-black text-xl">0.00 EUR</div>
                            </div>
                        </div>
                        <div class="text-center space-y-6">
                            <div class="relative">
                                <svg class="w-48 h-48 mx-auto transform -rotate-90">
                                    <circle cx="96" cy="96" r="86" stroke="#1f2937" stroke-width="12" fill="transparent" />
                                    <circle id="upgrade-circle" cx="96" cy="96" r="86" stroke="#a855f7" stroke-width="12" fill="transparent" stroke-dasharray="540" stroke-dashoffset="540" class="transition-all duration-1000 ease-out" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center flex-col">
                                    <span id="upgrade-chance" class="text-5xl font-black text-white italic drop-shadow-lg">0%</span>
                                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Šance</span>
                                </div>
                            </div>
                            <button onclick="attemptUpgrade()" id="btn-upgrade-exec" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-black py-5 rounded-2xl uppercase italic shadow-lg shadow-purple-500/30 active:scale-95 transition-all tracking-tighter text-xl">Vylepšit</button>
                        </div>
                        <div class="space-y-4 h-full flex flex-col justify-center">
                            <h3 class="text-gray-400 font-black uppercase text-sm tracking-widest text-center mb-2">Cílový skin</h3>
                            <div id="upg-target-slot" onclick="openSelector('target')" class="bg-gray-900/50 border-2 border-dashed border-purple-500/50 hover:border-yellow-400 rounded-3xl h-64 flex flex-col items-center justify-center p-4 relative overflow-hidden cursor-pointer transition-all group">
                                <i data-lucide="search" class="w-10 h-10 text-purple-500/50 group-hover:text-yellow-400 mb-2 transition-colors"></i>
                                <span class="text-gray-500 font-bold uppercase text-xs text-center group-hover:text-white transition-colors">Vyber cíl z<br>databáze</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="page-inventory" class="page hidden max-w-7xl mx-auto space-y-8 fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 border-b border-white/5 pb-6">
                    <div>
                        <h2 class="text-4xl font-black uppercase italic tracking-tighter text-white">MŮJ <span class="text-yellow-400">INVENTÁŘ</span></h2>
                        <p id="inv-stats" class="text-gray-500 font-bold text-xs uppercase tracking-widest mt-1">0 předmětů v hodnotě 0.00 EUR</p>
                    </div>
                    <button onclick="sellAllSkins()" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white px-6 py-3 rounded-xl font-bold text-xs transition-all border border-red-500/20 uppercase tracking-widest">Prodat vše</button>
                </div>
                <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
            </section>

            <section id="page-selector" class="page hidden max-w-7xl mx-auto space-y-8 fade-in">
                <div class="flex items-center justify-between border-b border-white/10 pb-6">
                    <div>
                        <button onclick="switchPage('upgrade')" class="text-gray-500 hover:text-white flex items-center gap-2 font-bold uppercase text-xs tracking-widest transition-colors mb-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Zpět do Upgraderu</button>
                        <h2 id="selector-title" class="text-4xl font-black uppercase italic tracking-tighter text-white">VYBER SKIN</h2>
                    </div>
                </div>
                <div id="selector-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4"></div>
            </section>
        </main>
    </div>

    <style>
        #fast-open-toggle:checked + div { background-color: var(--accent); }
        #fast-open-toggle:checked + div + .dot { transform: translateX(20px); background-color: black; }
    </style>

    <script>
        const FALLBACK_IMG = "https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpot7HxfDhjx2jJemkV09-5lpS0lfL3D7fQmGRu58ByiOXO89Wj2Vbtr0BkZmmhcI7HclM4M1vXq1LtxLrugcG8tZ7IznFr6SIn43_D30vgT85F9rU";
        function handleImgError(img) { img.onerror = null; img.src = FALLBACK_IMG; img.classList.add('fallback-img'); }

        // --- ZVUKOVÝ ENGINE (Vylepšený a jemnější) ---
        let audioCtx; let audioInitialized = false;
        function initAudio() {
            if(!audioInitialized) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); audioInitialized = true; } 
            else if(audioCtx.state === 'suspended') { audioCtx.resume(); }
        }

        const SoundEngine = {
            playTick: () => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'sine'; // Mnohem jemnější
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.015, audioCtx.currentTime); // Hlasitost drasticky snížena
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            },
            playWin: (rarity) => {
                if(!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'triangle'; // Jemnější než square
                let baseFreq = rarity === 'gold' ? 523.25 : (rarity === 'red' ? 440 : 329.63);
                osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
                osc.frequency.setValueAtTime(baseFreq * 1.25, audioCtx.currentTime + 0.1);
                osc.frequency.setValueAtTime(baseFreq * 1.5, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime); // Snížená hlasitost
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.0);
                osc.start(); osc.stop(audioCtx.currentTime + 1.0);
            }
        };

        // --- BACKEND SIMULÁTOR (Příprava na Node.js) ---
        // V produkci tyto funkce zavolají fetch() na tvoje API.
        const BackendAPI = {
            openCase: async (caseId, quantity) => {
                const c = casesDB.find(x => x.id === caseId);
                let cost = c.price * quantity;
                if(balanceBase < cost) throw new Error("Nedostatek prostředků");
                
                balanceBase -= cost;
                
                let winnings = [];
                for(let i=0; i<quantity; i++) {
                    const roll = Math.random() * 100;
                    let sum = 0;
                    let winSkin = c.contents[0].skin;
                    for(let item of c.contents) {
                        sum += item.chance;
                        if(roll <= sum) { winSkin = item.skin; break; }
                    }
                    winnings.push(winSkin);
                }
                return winnings; // Vrací pole vyhraných skinů
            }
        };

        // --- DATABÁZE A STAV ---
        let balanceBase = 0.00;
        let openQuantity = 1;
        let userInventory = [];
        let activeCaseId = null;
        let isSpinning = false;
        let spinAnimationId = null;

        const KNIFE_TYPES = ["Bayonet", "Bowie Knife", "Butterfly Knife", "Classic Knife", "Falchion Knife", "Flip Knife", "Gut Knife", "Huntsman Knife", "Karambit", "M9 Bayonet", "Navaja Knife", "Nomad Knife", "Paracord Knife", "Shadow Daggers", "Skeleton Knife", "Stiletto Knife", "Survival Knife", "Talon Knife", "Ursus Knife", "Driver Gloves", "Sport Gloves", "Specialist Gloves", "Hand Wraps", "Moto Gloves"];

        // Stejná databáze jako minule
        const rawSkinData = `P250|Sand Dune|0.10|#4b69ff\nGlock-18|Catacombs|0.20|#4b69ff\nSSG 08|Abyss|0.50|#4b69ff\nP90|Grim|0.80|#4b69ff\nM4A4|Magnesium|1.00|#4b69ff\nMAC-10|Candy Apple|1.10|#4b69ff\nGlock-18|Weasel|1.20|#8847ff\nGlock-18|Moonrise|1.50|#8847ff\nUSP-S|Ticket to Hell|1.80|#8847ff\nP250|Asiimov|2.00|#8847ff\nAK-47|Elite Build|2.50|#8847ff\nM4A1-S|Night Terror|2.50|#8847ff\nAWP|Worm God|3.00|#8847ff\nUSP-S|Cyrex|3.50|#8847ff\nAK-47|Slate|4.00|#8847ff\nDesert Eagle|Light Rail|4.00|#8847ff\nAWP|Mortis|4.50|#d32ee6\nGlock-18|Water Elemental|5.00|#d32ee6\nUSP-S|Cortex|5.00|#d32ee6\nDesert Eagle|Conspiracy|6.00|#d32ee6\nAK-47|Phantom Disruptor|6.00|#d32ee6\nDesert Eagle|Mecha Industries|7.00|#d32ee6\nMAC-10|Neon Rider|8.00|#d32ee6\nAWP|Atheris|10.00|#8847ff\nM4A4|Desolate Space|10.00|#d32ee6\nGlock-18|Bullet Queen|12.00|#eb4b4b\nFAMAS|Commemoration|12.00|#eb4b4b\nM4A1-S|Decimator|14.00|#d32ee6\nAK-47|Redline|15.00|#d32ee6\nGlock-18|Neo-Noir|15.00|#eb4b4b\nM4A4|In Living Color|15.00|#eb4b4b\nAK-47|Ice Coaled|18.00|#d32ee6\nUSP-S|Neo-Noir|18.00|#eb4b4b\nM4A4|Neo-Noir|20.00|#d32ee6\nAWP|Neo-Noir|25.00|#eb4b4b\nUSP-S|Orion|25.00|#d32ee6\nM4A1-S|Hyper Beast|25.00|#eb4b4b\nM4A4|The Emperor|30.00|#eb4b4b\nAK-47|Asiimov|35.00|#eb4b4b\nM4A1-S|Player Two|35.00|#eb4b4b\nAK-47|Neon Rider|40.00|#eb4b4b\nUSP-S|Kill Confirmed|45.00|#eb4b4b\nUSP-S|Printstream|55.00|#d32ee6\nDesert Eagle|Printstream|60.00|#eb4b4b\nAK-47|Bloodsport|75.00|#eb4b4b\nAK-47|Vulcan|80.00|#eb4b4b\nAWP|Containment Breach|85.00|#eb4b4b\nAWP|Asiimov|110.00|#eb4b4b\nM4A1-S|Printstream|210.00|#eb4b4b\nDesert Eagle|Emerald Jörmungandr|350.00|#eb4b4b\nBayonet|Slaughter|450.00|#ebca44\nM4A1-S|Blue Phosphor|700.00|#d32ee6\nGlock-18|Fade|800.00|#ebca44\nDesert Eagle|Blaze|900.00|#eb4b4b\nM9 Bayonet|Doppler|900.00|#ebca44\nTalon Knife|Fade|1000.00|#ebca44\nKarambit|Tiger Tooth|1000.00|#ebca44\nKarambit|Doppler|1100.00|#ebca44\nKarambit|Fade|1200.00|#ebca44\nM9 Bayonet|Lore|1200.00|#ebca44\nDriver Gloves|King Snake|1200.00|#ebca44\nKarambit|Marble Fade|1300.00|#ebca44\nButterfly Knife|Slaughter|1400.00|#ebca44\nKarambit|Lore|1500.00|#ebca44\nM9 Bayonet|Autotronic|1500.00|#ebca44\nButterfly Knife|Doppler|1600.00|#ebca44\nSkeleton Knife|Crimson Web|1600.00|#ebca44\nButterfly Knife|Tiger Tooth|1700.00|#ebca44\nM9 Bayonet|Crimson Web|1800.00|#ebca44\nSkeleton Knife|Fade|1800.00|#ebca44\nButterfly Knife|Marble Fade|2000.00|#ebca44\nSport Gloves|Vice|2000.00|#ebca44\nButterfly Knife|Fade|2200.00|#ebca44\nM4A1-S|Welcome to the Jungle|2500.00|#ebca44\nAWP|Medusa|3000.00|#ebca44\nAK-47|Gold Arabesque|3000.00|#ebca44\nM4A4|Howl|3500.00|#ebca44\nSport Gloves|Pandoras Box|4000.00|#ebca44\nAK-47|Wild Lotus|4500.00|#ebca44\nAWP|Dragon Lore|5000.00|#ebca44\nAWP|Gungnir|6000.00|#ebca44`;
        
        const skinsDB = {};
        rawSkinData.trim().split("\n").forEach((line, idx) => {
            const [w, n, p, c] = line.split("|");
            let folder = KNIFE_TYPES.includes(w) ? "knives" : "skins";
            let urlWeapon = w.replace(/ /g, "_"); let urlName = n.replace(/ /g, "_").replace(/'/g, "");
            skinsDB[idx + 1] = { id: idx + 1, weapon: w, skinName: n, name: `${w} | ${n}`, price: parseFloat(p), color: c, img: `https://www.csgodatabase.com/images/${folder}/webp/${urlWeapon}_${urlName}.webp`, rarityName: c === '#ebca44' ? 'gold' : (c === '#eb4b4b' ? 'red' : (c === '#d32ee6' ? 'pink' : 'blue')) };
        });
        function findSkin(w, n) { return Object.values(skinsDB).find(s => s.weapon === w && s.skinName === n) || Object.values(skinsDB)[0]; }

        const casesDB = [];
        setTimeout(() => {
            casesDB.push(
                { id: "trash-or-knife", name: "1% KNIFE Risk", price: 25.00, color: "yellow-400", img: findSkin("M9 Bayonet", "Autotronic").img, contents: [{ skin: findSkin("P250", "Sand Dune"), chance: 99.0 }, { skin: findSkin("M9 Bayonet", "Autotronic"), chance: 1.0 }] },
                { id: "coinflip", name: "50/50 Profit", price: 50.00, color: "red", img: findSkin("AK-47", "Bloodsport").img, contents: [{ skin: findSkin("AK-47", "Slate"), chance: 50.0 }, { skin: findSkin("AK-47", "Bloodsport"), chance: 50.0 }] },
                { id: "budget", name: "Budget Grinder", price: 5.00, color: "blue", img: findSkin("AWP", "Worm God").img, contents: [{ skin: findSkin("Glock-18", "Catacombs"), chance: 60.0 }, { skin: findSkin("USP-S", "Ticket to Hell"), chance: 25.0 }, { skin: findSkin("AWP", "Mortis"), chance: 12.0 }, { skin: findSkin("M4A4", "Desolate Space"), chance: 2.5 }, { skin: findSkin("AK-47", "Redline"), chance: 0.5 }] },
                { id: "covert", name: "Covert Dreams", price: 100.00, color: "red", img: findSkin("AWP", "Asiimov").img, contents: [{ skin: findSkin("M4A4", "The Emperor"), chance: 65.0 }, { skin: findSkin("AK-47", "Vulcan"), chance: 25.0 }, { skin: findSkin("AWP", "Asiimov"), chance: 8.0 }, { skin: findSkin("Desert Eagle", "Emerald Jörmungandr"), chance: 2.0 }] },
                { id: "dragon", name: "Dragon Lore 1%", price: 200.00, color: "yellow-400", img: findSkin("AWP", "Dragon Lore").img, contents: [{ skin: findSkin("AWP", "Atheris"), chance: 80.0 }, { skin: findSkin("AWP", "Neo-Noir"), chance: 19.0 }, { skin: findSkin("AWP", "Dragon Lore"), chance: 1.0 }] }
            );
            renderCases(); startLiveDrops();
        }, 100);

        // --- UI & LOGIKA ---
        function openDeposit() {
            const m = document.getElementById('deposit-modal');
            const b = document.getElementById('deposit-box');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); b.classList.remove('scale-95'); }, 10);
        }
        function closeDeposit() {
            const m = document.getElementById('deposit-modal');
            const b = document.getElementById('deposit-box');
            m.classList.add('opacity-0'); b.classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        }
        function simDeposit(amount) {
            balanceBase += amount; updateUI(); closeDeposit(); showToast(`Simulovaný vklad: ${amount} EUR`); initAudio();
        }

        // Live Dropy: Realistický posuv
        const dropNames = ["Faker", "Pepa", "Hráč99", "Otík", "Karel", "Sniper", "NoobMaster", "ProPlayer", "Anonym", "CS2King"];
        function startLiveDrops() {
            const container = document.getElementById('live-drops-container');
            
            setInterval(() => {
                const s = Object.values(skinsDB)[Math.floor(Math.random() * Object.values(skinsDB).length)];
                const n = dropNames[Math.floor(Math.random() * dropNames.length)];
                
                const el = document.createElement('div');
                el.className = 'live-drop-item bg-[#1a1e26] border-b-2 rounded-lg p-1.5 flex items-center gap-2 min-w-[160px] shadow-md';
                el.style.borderColor = s.color;
                el.innerHTML = `
                    <img src="${s.img}" onerror="handleImgError(this)" class="w-8 h-6 object-contain drop-shadow">
                    <div class="flex flex-col truncate">
                        <span class="text-[9px] text-gray-500 font-bold">${n}</span>
                        <span class="text-[10px] font-black text-white truncate" style="color: ${s.color}">${s.name}</span>
                    </div>
                `;
                
                container.prepend(el);
                
                // Animace vstupu
                requestAnimationFrame(() => { el.classList.add('show'); });
                
                // Udržuj max 15 položek
                if(container.children.length > 15) {
                    const last = container.lastElementChild;
                    last.style.opacity = '0';
                    setTimeout(() => last.remove(), 500);
                }
            }, 2500); // Každých 2.5 vteřiny padne něco
        }

        function setOpenQty(q) {
            openQuantity = q;
            document.querySelectorAll('.qty-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if(activeCaseId) {
                const c = casesDB.find(x => x.id === activeCaseId);
                document.getElementById('view-case-price').textContent = `Cena: ${formatMoney(c.price * q)}`;
            }
        }

        // --- MULTI-WIN A EFEKTY ---
        let currentWinnings = []; // Uchovává aktuální výhry pro modal

        function showMultiWinModal(skins) {
            currentWinnings = skins;
            const modal = document.getElementById('win-modal');
            const grid = document.getElementById('win-items-grid');
            let totalVal = skins.reduce((a,b) => a + b.price, 0);
            
            document.getElementById('win-total-price').textContent = formatMoney(totalVal);
            document.getElementById('win-sell-price').textContent = formatMoney(totalVal);
            
            // Nastav glow podle nejdražšího skinu
            let bestSkin = skins.reduce((prev, current) => (prev.price > current.price) ? prev : current);
            document.getElementById('win-bg-glow').style.backgroundColor = bestSkin.color;

            grid.innerHTML = skins.map((s, i) => `
                <div class="bg-[#14171c] p-4 rounded-xl border-b-4 shadow-xl flex flex-col items-center justify-center opacity-0 transform translate-y-10 transition-all duration-500" style="border-color: ${s.color}; animation: slideUp 0.5s ease forwards ${i * 0.1}s;">
                    <img src="${s.img}" onerror="handleImgError(this)" class="h-24 object-contain drop-shadow-lg mb-2">
                    <div class="text-[10px] font-bold text-gray-400 uppercase">${s.name}</div>
                    <div class="text-sm font-black text-white">${formatMoney(s.price)}</div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                if(bestSkin.price > 50) createParticles(bestSkin.color);
                SoundEngine.playWin(bestSkin.rarityName);
            }, 50);

            document.getElementById('btn-win-sell').onclick = () => {
                balanceBase += totalVal; updateUI(); showToast(`Prodáno za ${formatMoney(totalVal)}`); closeWinModal();
            };
            document.getElementById('btn-win-keep').onclick = () => {
                currentWinnings.forEach(s => addToInventory(s)); showToast(`Vše uloženo do inventáře`); closeWinModal();
            };
        }

        function closeWinModal() {
            const modal = document.getElementById('win-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- OTEVÍRÁNÍ BEDEN ---
        function renderCases() {
            const grid = document.getElementById('cases-grid');
            grid.innerHTML = casesDB.map(c => `
                <div onclick="openCaseView('${c.id}')" class="bg-[#14171c] p-6 rounded-3xl border-2 border-transparent hover:border-${c.color}/50 cursor-pointer transition-all group text-center shadow-lg relative overflow-hidden">
                    <div class="absolute inset-0 bg-${c.color}/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <img src="${c.img}" onerror="handleImgError(this)" class="w-full h-32 object-contain group-hover:scale-110 transition-transform relative z-10 drop-shadow-xl mb-4">
                    <div class="font-black text-sm uppercase text-gray-300 relative z-10">${c.name}</div>
                    <div class="text-yellow-400 font-bold mt-1 relative z-10">${formatMoney(c.price)}</div>
                </div>
            `).join('');
        }

        function openCaseView(id) {
            activeCaseId = id;
            setOpenQty(1); // Default reset
            document.getElementById('fast-open-toggle').checked = false;
            
            const c = casesDB.find(x => x.id === id);
            document.getElementById('view-case-name').textContent = c.name;
            document.getElementById('view-case-price').textContent = `${formatMoney(c.price)}`;
            document.getElementById('view-case-name').style.color = getComputedStyle(document.documentElement).getPropertyValue(`--rarity-${c.color === 'yellow-400' ? 'gold' : c.color}`);

            // Připrav standardní spinner
            const area = document.getElementById('opening-area');
            area.innerHTML = `
                <div class="spinner-container">
                    <div class="blur-edges blur-left"></div><div class="blur-edges blur-right"></div>
                    <div class="spinner-selector"></div><div id="spinner-track"></div>
                </div>`;
            
            document.getElementById('view-case-contents').innerHTML = c.contents.map(item => `
                <div class="bg-gray-900/50 p-3 rounded-xl border-b-2 flex flex-col items-center text-center" style="border-color: ${item.skin.color}">
                    <img src="${item.skin.img}" onerror="handleImgError(this)" class="h-16 object-contain mb-2 drop-shadow-md">
                    <div class="text-[9px] font-bold text-gray-400 uppercase truncate w-full">${item.skin.name}</div>
                    <div class="text-[10px] font-black text-white">${item.chance}%</div>
                </div>
            `).join('');

            const btn = document.getElementById('btn-open-case');
            btn.onclick = () => execCaseOpen(c);
            btn.textContent = "OTEVŘÍT BEDNU"; btn.disabled = false; btn.classList.remove('opacity-50');

            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-case-view').classList.remove('hidden');
        }

        async function execCaseOpen(caseObj) {
            if(isSpinning) return;
            const isFast = document.getElementById('fast-open-toggle').checked || openQuantity > 1;

            let winnings;
            try {
                // Volání backend simulátoru
                winnings = await BackendAPI.openCase(caseObj.id, openQuantity);
            } catch (e) {
                return showToast(e.message, true);
            }

            updateUI();
            isSpinning = true;
            const btn = document.getElementById('btn-open-case');
            btn.textContent = "Otevírám..."; btn.disabled = true; btn.classList.add('opacity-50');

            if(isFast) {
                // INSTANT / MULTI OPEN Loci
                const area = document.getElementById('opening-area');
                area.innerHTML = `<div class="flex flex-wrap justify-center gap-4 py-4" id="multi-reveal-grid"></div>`;
                const grid = document.getElementById('multi-reveal-grid');
                
                grid.innerHTML = winnings.map((_, i) => `
                    <div class="flip-card" id="flip-card-${i}">
                        <div class="flip-card-inner shadow-lg">
                            <div class="flip-card-front"><i data-lucide="help-circle" class="w-10 h-10 opacity-50"></i></div>
                            <div class="flip-card-back" style="border-color: transparent;"></div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();

                // Postupné otáčení karet
                winnings.forEach((skin, i) => {
                    setTimeout(() => {
                        SoundEngine.playTick();
                        const card = document.getElementById(`flip-card-${i}`);
                        const back = card.querySelector('.flip-card-back');
                        back.style.borderColor = skin.color;
                        back.innerHTML = `<img src="${skin.img}" onerror="handleImgError(this)" class="h-20 mb-2 object-contain"><div class="text-[9px] font-black uppercase text-white truncate w-full">${skin.name}</div>`;
                        card.classList.add('flipped');
                        
                        // Po dotočení poslední karty
                        if(i === winnings.length - 1) {
                            setTimeout(() => {
                                isSpinning = false;
                                showMultiWinModal(winnings);
                                btn.textContent = "HRÁT ZNOVU"; btn.disabled = false; btn.classList.remove('opacity-50');
                            }, 800);
                        }
                    }, i * 200 + 100);
                });

            } else {
                // STANDARD SPINNER (Pouze pro qty=1)
                const area = document.getElementById('opening-area');
                if(!document.getElementById('spinner-track')) {
                    area.innerHTML = `<div class="spinner-container"><div class="blur-edges blur-left"></div><div class="blur-edges blur-right"></div><div class="spinner-selector"></div><div id="spinner-track"></div></div>`;
                }
                const track = document.getElementById('spinner-track');
                track.style.transition = 'none'; track.style.transform = 'translateX(0px)';
                
                const winningSkin = winnings[0];
                const totalItems = 60; const winningIndex = 50; const itemWidth = 148; 
                
                let html = '';
                for(let i = 0; i < totalItems; i++) {
                    let s = (i === winningIndex) ? winningSkin : caseObj.contents[Math.floor(Math.random() * caseObj.contents.length)].skin;
                    html += `<div class="spinner-item" style="border-color: ${s.color}"><img src="${s.img}" onerror="handleImgError(this)"><div class="text-[10px] font-black uppercase text-gray-300 mt-2 truncate w-full text-center">${s.name}</div></div>`;
                }
                track.innerHTML = html;

                setTimeout(() => {
                    const containerWidth = document.querySelector('.spinner-container').clientWidth;
                    const jitter = (Math.random() * (itemWidth - 20)) - ((itemWidth - 20) / 2); 
                    const finalOffset = (winningIndex * itemWidth) + (itemWidth / 2) - (containerWidth / 2) + jitter;

                    let lastCrossed = 0;
                    function checkTick() {
                        if(!isSpinning) return;
                        const transform = window.getComputedStyle(track).getPropertyValue('transform');
                        if(transform !== 'none') {
                            const currentX = Math.abs(new DOMMatrix(transform).m41);
                            const centerLine = currentX + (containerWidth / 2);
                            const itemIndexAtCenter = Math.floor(centerLine / itemWidth);
                            
                            if(itemIndexAtCenter > lastCrossed) {
                                SoundEngine.playTick(); lastCrossed = itemIndexAtCenter;
                            }
                        }
                        spinAnimationId = requestAnimationFrame(checkTick);
                    }
                    
                    track.style.transition = 'transform 6s cubic-bezier(0.1, 0, 0.1, 1)';
                    track.style.transform = `translateX(-${finalOffset}px)`;
                    checkTick();

                    setTimeout(() => {
                        isSpinning = false; cancelAnimationFrame(spinAnimationId);
                        showMultiWinModal([winningSkin]);
                        btn.textContent = "HRÁT ZNOVU"; btn.disabled = false; btn.classList.remove('opacity-50');
                    }, 6500); 
                }, 50);
            }
        }

        // Přidání stylů pro SlideUp animaci v MultiWin
        const style = document.createElement('style');
        style.textContent = `@keyframes slideUp { to { opacity: 1; transform: translateY(0); } }`;
        document.head.appendChild(style);

        window.onload = () => { lucide.createIcons(); switchPage('cases'); };
    </script>
</body>
</html>